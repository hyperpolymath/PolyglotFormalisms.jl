# SPDX-License-Identifier: PMPL-1.0-or-later
name: Well-Known Enforcement
permissions: read-all

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0'

jobs:
  check-wellknown:
    name: Verify .well-known directory
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Check for .well-known/security.txt
        run: |
          if [ ! -f ".well-known/security.txt" ]; then
            echo "❌ Missing: .well-known/security.txt"
            exit 1
          fi
          echo "✓ .well-known/security.txt exists"

      - name: Validate security.txt format
        run: |
          if ! grep -q "Contact:" .well-known/security.txt; then
            echo "❌ security.txt missing Contact field"
            exit 1
          fi
          if ! grep -q "Expires:" .well-known/security.txt; then
            echo "❌ security.txt missing Expires field"
            exit 1
          fi
          echo "✓ security.txt format valid"

      - name: Check expiration date
        run: |
          EXPIRES=$(grep "Expires:" .well-known/security.txt | cut -d' ' -f2)
          EXPIRES_EPOCH=$(date -d "$EXPIRES" +%s 2>/dev/null || echo 0)
          NOW_EPOCH=$(date +%s)

          if [ $EXPIRES_EPOCH -lt $NOW_EPOCH ]; then
            echo "⚠️  Warning: security.txt has expired"
            echo "Please update the Expires field in .well-known/security.txt"
          else
            DAYS_LEFT=$(( ($EXPIRES_EPOCH - $NOW_EPOCH) / 86400 ))
            echo "✓ security.txt valid for $DAYS_LEFT more days"
          fi
