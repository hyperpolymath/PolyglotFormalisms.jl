# SPDX-License-Identifier: PMPL-1.0-or-later
name: RSR Antipattern Detection
permissions: read-all

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  check-rsr-compliance:
    name: Rhodium Standard Repositories Compliance
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Check for banned Node.js files
        run: |
          if [ -f "package.json" ] || [ -f "package-lock.json" ] || [ -f "yarn.lock" ] || [ -f "pnpm-lock.yaml" ]; then
            echo "❌ RSR violation: Node.js package files found in Julia project"
            echo "Julia projects must use Pkg, not npm/yarn/pnpm"
            exit 1
          fi
          echo "✓ No Node.js package files found"

      - name: Check for banned Node.js directories
        run: |
          if [ -d "node_modules" ]; then
            echo "❌ RSR violation: node_modules directory found"
            exit 1
          fi
          echo "✓ No node_modules directory"

      - name: Check for TypeScript in Julia project
        run: |
          if find . -name "*.ts" -o -name "*.tsx" | grep -q .; then
            echo "❌ RSR violation: TypeScript files found in Julia project"
            echo "Use Julia, not TypeScript. Consider ReScript for type-safe JS if needed."
            exit 1
          fi
          echo "✓ No TypeScript files found"

      - name: Check for Python files (RSR policy)
        run: |
          if find . -path ./.git -prune -o -name "*.py" -print | grep -q .; then
            echo "❌ RSR violation: Python files found"
            echo "RSR policy: Use Julia for data/scientific computing, not Python"
            exit 1
          fi
          echo "✓ No Python files found"

      - name: Check for Go files (RSR policy)
        run: |
          if find . -name "*.go" | grep -q .; then
            echo "❌ RSR violation: Go files found"
            echo "RSR policy: Use Rust for systems programming, not Go"
            exit 1
          fi
          echo "✓ No Go files found"

      - name: Verify .machine_readable directory exists
        run: |
          if [ ! -d ".machine_readable" ]; then
            echo "❌ RSR violation: .machine_readable directory missing"
            echo "Required for SCM metadata files"
            exit 1
          fi
          echo "✓ .machine_readable directory exists"

      - name: Verify required SCM files
        run: |
          REQUIRED_SCM_FILES=(
            ".machine_readable/ECOSYSTEM.scm"
            ".machine_readable/META.scm"
            ".machine_readable/STATE.scm"
            ".machine_readable/DEPENDENCIES.scm"
            ".machine_readable/ROADMAP.scm"
            ".machine_readable/CHANGELOG.scm"
          )

          MISSING=0
          for file in "${REQUIRED_SCM_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing: $file"
              MISSING=1
            else
              echo "✓ Found: $file"
            fi
          done

          if [ $MISSING -eq 1 ]; then
            echo "❌ RSR violation: Required SCM files missing"
            exit 1
          fi

          echo "✓ All 6 required SCM files present"

      - name: Check for clean root directory
        run: |
          # Count files in root (excluding hidden files and directories)
          FILE_COUNT=$(find . -maxdepth 1 -type f ! -name ".*" | wc -l)

          if [ $FILE_COUNT -gt 15 ]; then
            echo "⚠️  Warning: Root directory has $FILE_COUNT files (consider organizing)"
            echo "Consider moving configuration files to appropriate directories"
          else
            echo "✓ Root directory is tidy ($FILE_COUNT files)"
          fi

      - name: Verify license file
        run: |
          if [ ! -f "LICENSE" ]; then
            echo "❌ RSR violation: LICENSE file missing"
            exit 1
          fi
          echo "✓ LICENSE file exists"

      - name: Check for SPDX headers in workflows
        run: |
          for workflow in .github/workflows/*.yml; do
            if ! head -1 "$workflow" | grep -q "SPDX-License-Identifier"; then
              echo "❌ Missing SPDX header: $workflow"
              exit 1
            fi
          done
          echo "✓ All workflows have SPDX headers"
